// follow-redirects@1.15.9 downloaded from https://ga.jspm.io/npm:follow-redirects@1.15.9/index.js

import*as e from"url";import*as t from"http";import*as r from"https";import*as o from"stream";import*as s from"assert";import*as i from"debug";import n from"process";var a=i;try{"default"in i&&(a=i.default)}catch(e){}var u={};var c;u=function(){if(!c){try{c=a("follow-redirects")}catch(e){}typeof c!=="function"&&(c=function(){})}c.apply(null,arguments)};var h=u;var d=e;try{"default"in e&&(d=e.default)}catch(e){}var l=t;try{"default"in t&&(l=t.default)}catch(e){}var p=r;try{"default"in r&&(p=r.default)}catch(e){}var f=o;try{"default"in o&&(f=o.default)}catch(e){}var m=s;try{"default"in s&&(m=s.default)}catch(e){}var _=typeof globalThis!=="undefined"?globalThis:typeof self!=="undefined"?self:global;var v={};var R=n;var y=d;var b=y.URL;var g=l;var q=p;var E=f.Writable;var T=m;var w=h;(function detectUnsupportedEnvironment(){var e=typeof R!=="undefined";var t=typeof window!=="undefined"&&typeof document!=="undefined";var r=isFunction(Error.captureStackTrace);e||!t&&r||console.warn("The follow-redirects package should be excluded from browser builds.")})();var U=false;try{T(new b(""))}catch(e){U=e.code==="ERR_INVALID_URL"}var L=["auth","host","hostname","href","path","pathname","port","protocol","query","search","hash"];var O=["abort","aborted","connect","error","socket","timeout"];var B=Object.create(null);O.forEach((function(e){B[e]=function(t,r,o){(this||_)._redirectable.emit(e,t,r,o)}}));var S=createErrorType("ERR_INVALID_URL","Invalid URL",TypeError);var x=createErrorType("ERR_FR_REDIRECTION_FAILURE","Redirected request failed");var j=createErrorType("ERR_FR_TOO_MANY_REDIRECTS","Maximum number of redirects exceeded",x);var k=createErrorType("ERR_FR_MAX_BODY_LENGTH_EXCEEDED","Request body larger than maxBodyLength limit");var H=createErrorType("ERR_STREAM_WRITE_AFTER_END","write after end");var C=E.prototype.destroy||noop;function RedirectableRequest(e,t){E.call(this||_);this._sanitizeOptions(e);(this||_)._options=e;(this||_)._ended=false;(this||_)._ending=false;(this||_)._redirectCount=0;(this||_)._redirects=[];(this||_)._requestBodyLength=0;(this||_)._requestBodyBuffers=[];t&&this.on("response",t);var r=this||_;(this||_)._onNativeResponse=function(e){try{r._processResponse(e)}catch(e){r.emit("error",e instanceof x?e:new x({cause:e}))}};this._performRequest()}RedirectableRequest.prototype=Object.create(E.prototype);RedirectableRequest.prototype.abort=function(){destroyRequest((this||_)._currentRequest);(this||_)._currentRequest.abort();this.emit("abort")};RedirectableRequest.prototype.destroy=function(e){destroyRequest((this||_)._currentRequest,e);C.call(this||_,e);return this||_};RedirectableRequest.prototype.write=function(e,t,r){if((this||_)._ending)throw new H;if(!isString(e)&&!isBuffer(e))throw new TypeError("data should be a string, Buffer or Uint8Array");if(isFunction(t)){r=t;t=null}if(e.length!==0)if((this||_)._requestBodyLength+e.length<=(this||_)._options.maxBodyLength){(this||_)._requestBodyLength+=e.length;(this||_)._requestBodyBuffers.push({data:e,encoding:t});(this||_)._currentRequest.write(e,t,r)}else{this.emit("error",new k);this.abort()}else r&&r()};RedirectableRequest.prototype.end=function(e,t,r){if(isFunction(e)){r=e;e=t=null}else if(isFunction(t)){r=t;t=null}if(e){var o=this||_;var s=(this||_)._currentRequest;this.write(e,t,(function(){o._ended=true;s.end(null,null,r)}));(this||_)._ending=true}else{(this||_)._ended=(this||_)._ending=true;(this||_)._currentRequest.end(null,null,r)}};RedirectableRequest.prototype.setHeader=function(e,t){(this||_)._options.headers[e]=t;(this||_)._currentRequest.setHeader(e,t)};RedirectableRequest.prototype.removeHeader=function(e){delete(this||_)._options.headers[e];(this||_)._currentRequest.removeHeader(e)};RedirectableRequest.prototype.setTimeout=function(e,t){var r=this||_;function destroyOnTimeout(t){t.setTimeout(e);t.removeListener("timeout",t.destroy);t.addListener("timeout",t.destroy)}function startTimer(t){r._timeout&&clearTimeout(r._timeout);r._timeout=setTimeout((function(){r.emit("timeout");clearTimer()}),e);destroyOnTimeout(t)}function clearTimer(){if(r._timeout){clearTimeout(r._timeout);r._timeout=null}r.removeListener("abort",clearTimer);r.removeListener("error",clearTimer);r.removeListener("response",clearTimer);r.removeListener("close",clearTimer);t&&r.removeListener("timeout",t);r.socket||r._currentRequest.removeListener("socket",startTimer)}t&&this.on("timeout",t);(this||_).socket?startTimer((this||_).socket):(this||_)._currentRequest.once("socket",startTimer);this.on("socket",destroyOnTimeout);this.on("abort",clearTimer);this.on("error",clearTimer);this.on("response",clearTimer);this.on("close",clearTimer);return this||_};["flushHeaders","getHeader","setNoDelay","setSocketKeepAlive"].forEach((function(e){RedirectableRequest.prototype[e]=function(t,r){return(this||_)._currentRequest[e](t,r)}}));["aborted","connection","socket"].forEach((function(e){Object.defineProperty(RedirectableRequest.prototype,e,{get:function(){return(this||_)._currentRequest[e]}})}));RedirectableRequest.prototype._sanitizeOptions=function(e){e.headers||(e.headers={});if(e.host){e.hostname||(e.hostname=e.host);delete e.host}if(!e.pathname&&e.path){var t=e.path.indexOf("?");if(t<0)e.pathname=e.path;else{e.pathname=e.path.substring(0,t);e.search=e.path.substring(t)}}};RedirectableRequest.prototype._performRequest=function(){var e=(this||_)._options.protocol;var t=(this||_)._options.nativeProtocols[e];if(!t)throw new TypeError("Unsupported protocol "+e);if((this||_)._options.agents){var r=e.slice(0,-1);(this||_)._options.agent=(this||_)._options.agents[r]}var o=(this||_)._currentRequest=t.request((this||_)._options,(this||_)._onNativeResponse);o._redirectable=this||_;for(var s of O)o.on(s,B[s]);(this||_)._currentUrl=/^\//.test((this||_)._options.path)?y.format((this||_)._options):(this||_)._options.path;if((this||_)._isRedirect){var i=0;var n=this||_;var a=(this||_)._requestBodyBuffers;(function writeNext(e){if(o===n._currentRequest)if(e)n.emit("error",e);else if(i<a.length){var t=a[i++];o.finished||o.write(t.data,t.encoding,writeNext)}else n._ended&&o.end()})()}};RedirectableRequest.prototype._processResponse=function(e){var t=e.statusCode;(this||_)._options.trackRedirects&&(this||_)._redirects.push({url:(this||_)._currentUrl,headers:e.headers,statusCode:t});var r=e.headers.location;if(!r||(this||_)._options.followRedirects===false||t<300||t>=400){e.responseUrl=(this||_)._currentUrl;e.redirects=(this||_)._redirects;this.emit("response",e);(this||_)._requestBodyBuffers=[]}else{destroyRequest((this||_)._currentRequest);e.destroy();if(++(this||_)._redirectCount>(this||_)._options.maxRedirects)throw new j;var o;var s=(this||_)._options.beforeRedirect;s&&(o=Object.assign({Host:e.req.getHeader("host")},(this||_)._options.headers));var i=(this||_)._options.method;if((t===301||t===302)&&(this||_)._options.method==="POST"||t===303&&!/^(?:GET|HEAD)$/.test((this||_)._options.method)){(this||_)._options.method="GET";(this||_)._requestBodyBuffers=[];removeMatchingHeaders(/^content-/i,(this||_)._options.headers)}var n=removeMatchingHeaders(/^host$/i,(this||_)._options.headers);var a=parseUrl((this||_)._currentUrl);var u=n||a.host;var c=/^\w+:/.test(r)?(this||_)._currentUrl:y.format(Object.assign(a,{host:u}));var h=resolveUrl(r,c);w("redirecting to",h.href);(this||_)._isRedirect=true;spreadUrlObject(h,(this||_)._options);(h.protocol!==a.protocol&&h.protocol!=="https:"||h.host!==u&&!isSubdomain(h.host,u))&&removeMatchingHeaders(/^(?:(?:proxy-)?authorization|cookie)$/i,(this||_)._options.headers);if(isFunction(s)){var d={headers:e.headers,statusCode:t};var l={url:c,method:i,headers:o};s((this||_)._options,d,l);this._sanitizeOptions((this||_)._options)}this._performRequest()}};function wrap(e){var t={maxRedirects:21,maxBodyLength:10485760};var r={};Object.keys(e).forEach((function(o){var s=o+":";var i=r[s]=e[o];var n=t[o]=Object.create(i);function request(e,o,i){if(isURL(e))e=spreadUrlObject(e);else if(isString(e))e=spreadUrlObject(parseUrl(e));else{i=o;o=validateUrl(e);e={protocol:s}}if(isFunction(o)){i=o;o=null}o=Object.assign({maxRedirects:t.maxRedirects,maxBodyLength:t.maxBodyLength},e,o);o.nativeProtocols=r;isString(o.host)||isString(o.hostname)||(o.hostname="::1");T.equal(o.protocol,s,"protocol mismatch");w("options",o);return new RedirectableRequest(o,i)}function get(e,t,r){var o=n.request(e,t,r);o.end();return o}Object.defineProperties(n,{request:{value:request,configurable:true,enumerable:true,writable:true},get:{value:get,configurable:true,enumerable:true,writable:true}})}));return t}function noop(){}function parseUrl(e){var t;if(U)t=new b(e);else{t=validateUrl(y.parse(e));if(!isString(t.protocol))throw new S({input:e})}return t}function resolveUrl(e,t){return U?new b(e,t):parseUrl(y.resolve(t,e))}function validateUrl(e){if(/^\[/.test(e.hostname)&&!/^\[[:0-9a-f]+\]$/i.test(e.hostname))throw new S({input:e.href||e});if(/^\[/.test(e.host)&&!/^\[[:0-9a-f]+\](:\d+)?$/i.test(e.host))throw new S({input:e.href||e});return e}function spreadUrlObject(e,t){var r=t||{};for(var o of L)r[o]=e[o];r.hostname.startsWith("[")&&(r.hostname=r.hostname.slice(1,-1));r.port!==""&&(r.port=Number(r.port));r.path=r.search?r.pathname+r.search:r.pathname;return r}function removeMatchingHeaders(e,t){var r;for(var o in t)if(e.test(o)){r=t[o];delete t[o]}return r===null||typeof r==="undefined"?void 0:String(r).trim()}function createErrorType(e,t,r){function CustomError(r){isFunction(Error.captureStackTrace)&&Error.captureStackTrace(this||_,(this||_).constructor);Object.assign(this||_,r||{});(this||_).code=e;(this||_).message=(this||_).cause?t+": "+(this||_).cause.message:t}CustomError.prototype=new(r||Error);Object.defineProperties(CustomError.prototype,{constructor:{value:CustomError,enumerable:false},name:{value:"Error ["+e+"]",enumerable:false}});return CustomError}function destroyRequest(e,t){for(var r of O)e.removeListener(r,B[r]);e.on("error",noop);e.destroy(t)}function isSubdomain(e,t){T(isString(e)&&isString(t));var r=e.length-t.length-1;return r>0&&e[r]==="."&&e.endsWith(t)}function isString(e){return typeof e==="string"||e instanceof String}function isFunction(e){return typeof e==="function"}function isBuffer(e){return typeof e==="object"&&"length"in e}function isURL(e){return b&&e instanceof b}v=wrap({http:g,https:q});v.wrap=wrap;var F=v;const N=v.wrap;export{F as default,N as wrap};

