// http-auth@3.1.3 downloaded from https://ga.jspm.io/npm:http-auth@3.1.3/src/http-auth.js

import e from"crypto";import t from"buffer";import s from"http";import r from"fs";import i from"events";import a from"https";import o from"http-proxy";import n from"apache-md5";import c from"apache-crypt";import h from"bcryptjs";import l from"uuid";import p from"passport";import u from"util";var d={};function _nullRequire(e){var t=new Error("Cannot find module '"+e+"'");t.code="MODULE_NOT_FOUND";throw t}_nullRequire.resolve=_nullRequire;var f=t.Buffer;const m=e;const g={};g.md5=e=>{let t=m.createHash("MD5");t.update(e);return t.digest("hex")};g.sha1=e=>{let t=m.createHash("sha1");t.update(e);return t.digest("base64")};g.base64=e=>new f(e,"utf8").toString("base64");g.decodeBase64=e=>new f(e,"base64").toString("utf8");g.isAvailable=e=>{try{return!!_nullRequire(e)}catch(e){return false}};d=g;var v=d;var y={};const b=r;const $=i;class Base extends $.EventEmitter{constructor(e,t){super();e.msg401||(e.msg401="401 Unauthorized");e.msg407||(e.msg407="407 Proxy authentication required");e.contentType||(e.contentType="text/plain");e.realm||(e.realm="users");this.options=e;this.checker=t;this.options.users=[];!t&&e.file&&this.loadUsers()}processLine(e){throw new Error("Not defined!")}parseAuthorization(e){throw new Error("Not defined!")}findUser(e,t,s){throw new Error("Not defined!")}generateHeader(e){throw new Error("Not defined!")}ask(e,t){let s=this.generateHeader(t);e.setHeader("Content-Type",this.options.contentType);if(this.proxy){e.setHeader("Proxy-Authenticate",s);e.writeHead(407);e.end(this.options.msg407)}else{e.setHeader("WWW-Authenticate",s);e.writeHead(401);e.end(this.options.msg401)}}check(e,t,s){let r=this;this.isAuthenticated(e,i=>{if(i instanceof Error){r.emit("error",i,e);s&&s.apply(r,[e,t,i])}else if(i.pass){r.emit("success",i,e);this.options.skipUser||(e.user=i.user);s&&s.apply(r,[e,t])}else{r.emit("fail",i,e);r.ask(t,i)}})}isAuthenticated(e,t){let s=this;let r=void 0;r=this.proxy?e.headers["proxy-authorization"]:e.headers["authorization"];let i=false;if(r){let a=this.parseAuthorization(r);if(a){i=true;this.findUser(e,a,e=>{t.apply(s,[e])})}}i||t.apply(this,[{}])}loadUsers(){let e=b.readFileSync(this.options.file,"UTF-8").replace(/\r\n/g,"\n").split("\n");e.forEach(e=>{e&&!e.match(/^\s*#.*/)&&this.processLine(e)})}}y=Base;var w=y;const k=s;const E=w;const S=k.createServer;k.createServer=function(){let e=void 0;if(arguments[0]instanceof E){let t=arguments[0];if(arguments[1]){let s=arguments[1];let newListener=(e,r)=>{t.check(e,r,(e,t,r)=>{if(r){console.error(r);t.statusCode=400;t.end(r.message)}else s(e,t)})};e=S.apply(k,[newListener])}else{e=S.apply(k,[]);e.on("request",(e,s)=>{t.check(e,s)})}}else e=S.apply(k,arguments);return e};var x={};const H=a;const q=w;let A=H.createServer;H.createServer=function(){let e=void 0;if(arguments[0]instanceof q){let t=arguments[0];if(arguments[2]){let s=arguments[2];let newListener=(e,r)=>{t.check(e,r,(e,t,r)=>{if(r){console.error(r);t.statusCode=400;t.end(r.message)}else s(e,t)})};e=A.apply(H,[arguments[1],newListener])}else{e=A.apply(H,[arguments[1]]);e.on("request",(e,s)=>{t.check(e,s)})}}else e=A.apply(H,arguments);return e};var N={};const D=o;const U=w;const B=D.createServer;const newCreateServer=function(e,t){if(e instanceof U)e.proxy=true;else{t=e;e=null}let s=B.apply(D,[t]);if(e){let t=s.web;s.web=function(r,i){let a=arguments;e.check(r,i,(e,r,i)=>{if(i){console.error(i);r.statusCode=400;r.end(i.message)}else t.apply(s,a)})}}return s};D.createServer=D.createProxyServer=D.createProxy=newCreateServer;var T={};var j={};var z=t.Buffer;const M=w;const C=v;const L=n;const W=c;const _=h;const P=e;class Basic extends M{constructor(e,t){super(e,t)}validate(e,t){if("{SHA}"===e.substr(0,5)){e=e.substr(5);return e===C.sha1(t)}return"$apr1$"===e.substr(0,6)||"$1$"===e.substr(0,3)?e===L(t,e):"$2y$"===e.substr(0,4)||"$2a$"===e.substr(0,4)?_.compareSync(t,e):e===W(t,e)||(e.length===t.length?P.timingSafeEqual?P.timingSafeEqual(new z(e),new z(t)):e===t:void 0)}processLine(e){let t=e.split(":");let s=t.shift();let r=t.join(":");this.options.users.push({username:s,hash:r})}generateHeader(){return`Basic realm="${this.options.realm}"`}parseAuthorization(e){let t=e.split(" ");if("Basic"===t[0])return t[1]}findUser(e,t,s){let r=C.decodeBase64(t).split(":");let i=r.shift();let a=r.join(":");let o=this;if(this.checker)this.checker.apply(this,[i,a,e=>{let t=void 0;t=e instanceof Error?[e]:[{user:i,pass:!!e}];s.apply(o,t)},e]);else{let e=false;this.options.users.forEach(t=>{t.username===i&&this.validate(t.hash,a)&&(e=true)});s.apply(this,[{user:i,pass:e}])}}}j=(e,t)=>new Basic(e,t);var O=j;var R={};const F=w;const I=v;const G=l;class Digest extends F{constructor(e,t){super(e,t);this.nonces=[];"MD5-sess"!==e.algorithm&&(this.options.algorithm="MD5");"none"===e.qop?this.options.qop="":this.options.qop="auth"}processLine(e){let t=e.split(":");this.options.realm===t[1]&&this.options.users.push({username:t[0],hash:t[2]})}parseAuthorization(e){let t={};let s=e.split(" ");let r=s.slice(1).join(" ");let i=r.split(/,(?=(?:[^"]|"[^"]*")*$)/);if("Digest"===s[0].substr(0,6)){let e=0;let s=i.length;while(e<s){let s=/(\w+)=["]?([^"]*)["]?$/.exec(i[e]);s&&(t[s[1]]=s[2]);++e}}return t}validate(e,t,s){let r=s;"MD5-sess"===t.algorithm&&(r=I.md5(`${r}:${t.nonce}:${t.cnonce}`));let i=void 0;i=t.qop?I.md5(`${r}:${t.nonce}:${t.nc}:${t.cnonce}:${t.qop}:${e}`):I.md5(`${r}:${t.nonce}:${e}`);return i===t.response}findUser(e,t,s){let r=this;if(this.validateNonce(t.nonce,t.qop,t.nc)){let i=I.md5(`${e.method}:${t.uri}`);if(this.checker)this.checker.apply(this,[t.username,e=>{let a=void 0;a=e instanceof Error?[e]:[{user:t.username,pass:!!r.validate(i,t,e)}];s.apply(this,a)},e]);else{let e=false;this.options.users.forEach(s=>{s.username===t.username&&this.validate(i,t,s.hash)&&(e=true)});s.apply(this,[{user:t.username,pass:e}])}}else s.apply(this,[{stale:true}])}removeNonces(e){e.forEach(e=>{let t=this.nonces.indexOf(e);-1!=t&&this.nonces.splice(t,1)})}validateNonce(e,t,s){let r=false;let i=Date.now();let a=[];this.nonces.forEach(o=>{if(o[1]+36e5>i){if(o[0]===e)if(t){if(s>o[2]){r=true;++o[2]}}else r=true}else a.push(o)});this.removeNonces(a);return r}askNonce(){let e=I.md5(G());this.nonces.push([e,Date.now(),0]);return e}generateHeader(e){let t=this.askNonce();let s=!!e.stale;return`Digest realm="${this.options.realm}", qop="${this.options.qop}", nonce="${t}", algorithm="${this.options.algorithm}", stale="${s}"`}}R=(e,t)=>new Digest(e,t);var J=R;var K={};K=e=>(t,s,r)=>{e.check(t,s,(e,t,s)=>{s?r(s):r()})};var Q=K;var V={};V=e=>{const koa=(t,s,r)=>{e.check(t,s,(e,t,s)=>{if(s)throw s;r()})};return function*(e){yield koa.bind(null,this.req,this.res);yield e}};var X=V;var Y={};const Z=p;const ee=u;function HttpStrategy(e){this.name="http";this.authentication=e;Z.Strategy.call(this)}ee.inherits(HttpStrategy,Z.Strategy);HttpStrategy.prototype.authenticate=function(e){let t=this;this.authentication.isAuthenticated(e,e=>{if(e instanceof Error)t.error(e);else if(e.pass)t.success(e.user);else{let s=t.authentication.generateHeader(e);t.fail(s)}})};Y=e=>new HttpStrategy(e);var te=Y;var se={name:"http-auth",description:"Node.js package for HTTP basic and digest access authentication.",version:"3.1.3",author:"Gevorg Harutyunyan (http://github.com/gevorg)",maintainers:[{name:"gevorg",email:"gevorg.ha@gmail.com"}],homepage:"http://http-auth.info",repository:{type:"git",url:"http://github.com/http-auth/http-auth.git"},main:"./src/http-auth.js",licenses:[{type:"MIT",url:"http://github.com/http-auth/http-auth/blob/master/LICENSE"}],license:"MIT",bugs:{url:"http://github.com/http-auth/http-auth/issues"},dependencies:{"apache-crypt":"^1.1.2","apache-md5":"^1.0.6",bcryptjs:"^2.3.0",uuid:"^3.0.0"},devDependencies:{chai:"^3.5.0",express:"^4.13.4","http-proxy":"^1.13.3",koa:"^1.2.0",hapi:"^15.0.3",mocha:"^3.1.2",passport:"^0.3.2",request:"^2.72.0"},engines:{node:">=4.6.1"},scripts:{test:"mocha"},keywords:["http","basic","digest","access","authentication"]};var re={};const httpScheme=(e,t)=>({authenticate:(e,s)=>{t.isAuthenticated(e,e=>{if(e instanceof Error)return s(e,null,{credentials:null});if(e.pass)return s.continue({credentials:{name:e.user}});{let r=t.generateHeader(e);return s(t.options.msg401).code(401).header("WWW-Authenticate",r)}})}});re.register=(e,t,s)=>{e.auth.scheme("http",httpScheme);s()};re.register.attributes={pkg:se};var ie={};const ae=v;x;N;ae.isAvailable("http-proxy")&&T;ie={basic:(e,t)=>O(e,t),digest:(e,t)=>J(e,t),connect:e=>Q(e),koa:e=>X(e),passport:e=>te(e),hapi:()=>re};var oe=ie;export default oe;

