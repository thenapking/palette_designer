// websocket-driver@0.7.4 downloaded from https://ga.jspm.io/npm:websocket-driver@0.7.4/lib/websocket/driver.js

import e from"safe-buffer";import"events";import t from"util";import s from"stream";import{_ as r,a as i}from"../../_/16b7de5b.js";import a from"./driver/headers.js";import h from"crypto";import n from"url";import o from"http-parser-js";import u from"process";import"websocket-extensions";var c={};var d=u;var f=o.HTTPParser,_=e.Buffer;var p={request:f.REQUEST||"request",response:f.RESPONSE||"response"};var HttpParser=function(e){this._type=e;this._parser=new f(p[e]);this._complete=false;this.headers={};var t=null,s=this;this._parser.onHeaderField=function(e,s,r){t=e.toString("utf8",s,s+r).toLowerCase()};this._parser.onHeaderValue=function(e,r,i){var a=e.toString("utf8",r,r+i);s.headers.hasOwnProperty(t)?s.headers[t]+=", "+a:s.headers[t]=a};this._parser.onHeadersComplete=this._parser[f.kOnHeadersComplete]=function(e,t,r,i,a,h){var n=arguments[0];if("object"===typeof n){i=n.method;a=n.url;h=n.statusCode;r=n.headers}s.method="number"===typeof i?HttpParser.METHODS[i]:i;s.statusCode=h;s.url=a;if(r){for(var o=0,u=r.length,c,d;o<u;o+=2){c=r[o].toLowerCase();d=r[o+1];s.headers.hasOwnProperty(c)?s.headers[c]+=", "+d:s.headers[c]=d}s._complete=true}}};HttpParser.METHODS={0:"DELETE",1:"GET",2:"HEAD",3:"POST",4:"PUT",5:"CONNECT",6:"OPTIONS",7:"TRACE",8:"COPY",9:"LOCK",10:"MKCOL",11:"MOVE",12:"PROPFIND",13:"PROPPATCH",14:"SEARCH",15:"UNLOCK",16:"BIND",17:"REBIND",18:"UNBIND",19:"ACL",20:"REPORT",21:"MKACTIVITY",22:"CHECKOUT",23:"MERGE",24:"M-SEARCH",25:"NOTIFY",26:"SUBSCRIBE",27:"UNSUBSCRIBE",28:"PATCH",29:"PURGE",30:"MKCALENDAR",31:"LINK",32:"UNLINK"};var l=d.version?d.version.match(/[0-9]+/g).map((function(e){return parseInt(e,10)})):[];if(0===l[0]&&12===l[1]){HttpParser.METHODS[16]="REPORT";HttpParser.METHODS[17]="MKACTIVITY";HttpParser.METHODS[18]="CHECKOUT";HttpParser.METHODS[19]="MERGE";HttpParser.METHODS[20]="M-SEARCH";HttpParser.METHODS[21]="NOTIFY";HttpParser.METHODS[22]="SUBSCRIBE";HttpParser.METHODS[23]="UNSUBSCRIBE";HttpParser.METHODS[24]="PATCH";HttpParser.METHODS[25]="PURGE"}HttpParser.prototype.isComplete=function(){return this._complete};HttpParser.prototype.parse=function(e){var t=this._parser.execute(e,0,e.length);if("number"===typeof t)this._complete&&(this.body=t<e.length?e.slice(t):_.alloc(0));else{this.error=t;this._complete=true}};c=HttpParser;var g=c;var S={};var v=e.Buffer,m=s.Stream,y=n,k=t,b=r,E=a,w=g;var C={"ws:":80,"wss:":443};var Proxy=function(e,t,s){this._client=e;this._http=new w("response");this._origin="object"===typeof e.url?e.url:y.parse(e.url);this._url="object"===typeof t?t:y.parse(t);this._options=s||{};this._state=0;this.readable=this.writable=true;this._paused=false;this._headers=new E;this._headers.set("Host",this._origin.host);this._headers.set("Connection","keep-alive");this._headers.set("Proxy-Connection","keep-alive");var r=this._url.auth&&v.from(this._url.auth,"utf8").toString("base64");r&&this._headers.set("Proxy-Authorization","Basic "+r)};k.inherits(Proxy,m);var O={setHeader:function(e,t){if(0!==this._state)return false;this._headers.set(e,t);return true},start:function(){if(0!==this._state)return false;this._state=1;var e=this._origin,t=e.port||C[e.protocol],s="CONNECT "+e.hostname+":"+t+" HTTP/1.1";var r=[s,this._headers.toString(),""];this.emit("data",v.from(r.join("\r\n"),"utf8"));return true},pause:function(){this._paused=true},resume:function(){this._paused=false;this.emit("drain")},write:function(e){if(!this.writable)return false;this._http.parse(e);if(!this._http.isComplete())return!this._paused;this.statusCode=this._http.statusCode;this.headers=this._http.headers;if(200===this.statusCode)this.emit("connect",new b.ConnectEvent);else{var t="Can't establish a connection to the server at "+this._origin.href;this.emit("error",new Error(t))}this.end();return!this._paused},end:function(e){if(this.writable){void 0!==e&&this.write(e);this.readable=this.writable=false;this.emit("close");this.emit("end")}},destroy:function(){this.end()}};for(var H in O)Proxy.prototype[H]=O[H];S=Proxy;var T=S;var R={};var B=e.Buffer,P=h,U=n,I=t,M=g,D=r,L=i,N=T;var Client=function(e,t){this.version="hybi-"+L.VERSION;L.call(this,null,e,t);this.readyState=-1;this._key=Client.generateKey();this._accept=L.generateAccept(this._key);this._http=new M("response");var s=U.parse(this.url),r=s.auth&&B.from(s.auth,"utf8").toString("base64");if(this.VALID_PROTOCOLS.indexOf(s.protocol)<0)throw new Error(this.url+" is not a valid WebSocket URL");this._pathname=(s.pathname||"/")+(s.search||"");this._headers.set("Host",s.host);this._headers.set("Upgrade","websocket");this._headers.set("Connection","Upgrade");this._headers.set("Sec-WebSocket-Key",this._key);this._headers.set("Sec-WebSocket-Version",L.VERSION);this._protocols.length>0&&this._headers.set("Sec-WebSocket-Protocol",this._protocols.join(", "));r&&this._headers.set("Authorization","Basic "+r)};I.inherits(Client,L);Client.generateKey=function(){return P.randomBytes(16).toString("base64")};var q={VALID_PROTOCOLS:["ws:","wss:"],proxy:function(e,t){return new N(this,e,t)},start:function(){if(-1!==this.readyState)return false;this._write(this._handshakeRequest());this.readyState=0;return true},parse:function(e){if(3!==this.readyState){if(this.readyState>0)return L.prototype.parse.call(this,e);this._http.parse(e);if(this._http.isComplete()){this._validateHandshake();if(3!==this.readyState){this._open();this.parse(this._http.body)}}}},_handshakeRequest:function(){var e=this._extensions.generateOffer();e&&this._headers.set("Sec-WebSocket-Extensions",e);var t="GET "+this._pathname+" HTTP/1.1",s=[t,this._headers.toString(),""];return B.from(s.join("\r\n"),"utf8")},_failHandshake:function(e){e="Error during WebSocket handshake: "+e;this.readyState=3;this.emit("error",new Error(e));this.emit("close",new D.CloseEvent(this.ERRORS.protocol_error,e))},_validateHandshake:function(){this.statusCode=this._http.statusCode;this.headers=this._http.headers;if(this._http.error)return this._failHandshake(this._http.error.message);if(101!==this._http.statusCode)return this._failHandshake("Unexpected response code: "+this._http.statusCode);var e=this._http.headers,t=e["upgrade"]||"",s=e["connection"]||"",r=e["sec-websocket-accept"]||"",i=e["sec-websocket-protocol"]||"";if(""===t)return this._failHandshake("'Upgrade' header is missing");if("websocket"!==t.toLowerCase())return this._failHandshake("'Upgrade' header value is not 'WebSocket'");if(""===s)return this._failHandshake("'Connection' header is missing");if("upgrade"!==s.toLowerCase())return this._failHandshake("'Connection' header value is not 'Upgrade'");if(r!==this._accept)return this._failHandshake("Sec-WebSocket-Accept mismatch");this.protocol=null;if(""!==i){if(this._protocols.indexOf(i)<0)return this._failHandshake("Sec-WebSocket-Protocol mismatch");this.protocol=i}try{this._extensions.activate(this.headers["sec-websocket-extensions"])}catch(e){return this._failHandshake(e.message)}}};for(var W in q)Client.prototype[W]=q[W];R=Client;var x=R;var A={};var K=e.Buffer,V=r,j=t;var Draft75=function(e,t,s){V.apply(this,arguments);this._stage=0;this.version="hixie-75";this._headers.set("Upgrade","WebSocket");this._headers.set("Connection","Upgrade");this._headers.set("WebSocket-Origin",this._request.headers.origin);this._headers.set("WebSocket-Location",this.url)};j.inherits(Draft75,V);var Y={close:function(){if(3===this.readyState)return false;this.readyState=3;this.emit("close",new V.CloseEvent(null,null));return true},parse:function(e){if(!(this.readyState>1)){this._reader.put(e);this._reader.eachByte((function(e){var t;switch(this._stage){case-1:this._body.push(e);this._sendHandshakeBody();break;case 0:this._parseLeadingByte(e);break;case 1:this._length=(127&e)+128*this._length;if(this._closing&&0===this._length)return this.close();if(128!==(128&e))if(0===this._length)this._stage=0;else{this._skipped=0;this._stage=2}break;case 2:if(255===e){this._stage=0;t=K.from(this._buffer).toString("utf8",0,this._buffer.length);this.emit("message",new V.MessageEvent(t))}else if(this._length){this._skipped+=1;this._skipped===this._length&&(this._stage=0)}else{this._buffer.push(e);if(this._buffer.length>this._maxLength)return this.close()}break}}),this)}},frame:function(e){if(0===this.readyState)return this._queue([e]);if(this.readyState>1)return false;"string"!==typeof e&&(e=e.toString());var t=K.byteLength(e),s=K.allocUnsafe(t+2);s[0]=0;s.write(e,1);s[s.length-1]=255;this._write(s);return true},_handshakeResponse:function(){var e="HTTP/1.1 101 Web Socket Protocol Handshake",t=[e,this._headers.toString(),""];return K.from(t.join("\r\n"),"utf8")},_parseLeadingByte:function(e){if(128===(128&e)){this._length=0;this._stage=1}else{delete this._length;delete this._skipped;this._buffer=[];this._stage=2}}};for(var G in Y)Draft75.prototype[G]=Y[G];A=Draft75;var Z=A;var F={};var z=e.Buffer,Q=r,J=Z,X=h,$=t;var numberFromKey=function(e){return parseInt((e.match(/[0-9]/g)||[]).join(""),10)};var spacesInKey=function(e){return(e.match(/ /g)||[]).length};var Draft76=function(e,t,s){J.apply(this,arguments);this._stage=-1;this._body=[];this.version="hixie-76";this._headers.clear();this._headers.set("Upgrade","WebSocket");this._headers.set("Connection","Upgrade");this._headers.set("Sec-WebSocket-Origin",this._request.headers.origin);this._headers.set("Sec-WebSocket-Location",this.url)};$.inherits(Draft76,J);var ee={BODY_SIZE:8,start:function(){if(!J.prototype.start.call(this))return false;this._started=true;this._sendHandshakeBody();return true},close:function(){if(3===this.readyState)return false;1===this.readyState&&this._write(z.from([255,0]));this.readyState=3;this.emit("close",new Q.CloseEvent(null,null));return true},_handshakeResponse:function(){var e=this._request.headers,t=e["sec-websocket-key1"],s=e["sec-websocket-key2"];if(!t)throw new Error("Missing required header: Sec-WebSocket-Key1");if(!s)throw new Error("Missing required header: Sec-WebSocket-Key2");var r=numberFromKey(t),i=spacesInKey(t),a=numberFromKey(s),h=spacesInKey(s);if(r%i!==0||a%h!==0)throw new Error("Client sent invalid Sec-WebSocket-Key headers");this._keyValues=[r/i,a/h];var n="HTTP/1.1 101 WebSocket Protocol Handshake",e=[n,this._headers.toString(),""];return z.from(e.join("\r\n"),"binary")},_handshakeSignature:function(){if(this._body.length<this.BODY_SIZE)return null;var e=X.createHash("md5"),t=z.allocUnsafe(8+this.BODY_SIZE);t.writeUInt32BE(this._keyValues[0],0);t.writeUInt32BE(this._keyValues[1],4);z.from(this._body).copy(t,8,0,this.BODY_SIZE);e.update(t);return z.from(e.digest("binary"),"binary")},_sendHandshakeBody:function(){if(this._started){var e=this._handshakeSignature();if(e){this._write(e);this._stage=0;this._open();this._body.length>this.BODY_SIZE&&this.parse(this._body.slice(this.BODY_SIZE))}}},_parseLeadingByte:function(e){if(255!==e)return J.prototype._parseLeadingByte.call(this,e);this._closing=true;this._length=0;this._stage=1}};for(var te in ee)Draft76.prototype[te]=ee[te];F=Draft76;var se=F;var re={};var ie=t,ae=g,he=r,ne=Z,oe=se,ue=i;var Server=function(e){he.call(this,null,null,e);this._http=new ae("request")};ie.inherits(Server,he);var ce={EVENTS:["open","message","error","close","ping","pong"],_bindEventListeners:function(){this.messages.on("error",(function(){}));this.on("error",(function(){}))},parse:function(e){if(this._delegate)return this._delegate.parse(e);this._http.parse(e);if(this._http.isComplete()){this.method=this._http.method;this.url=this._http.url;this.headers=this._http.headers;this.body=this._http.body;var t=this;this._delegate=Server.http(this,this._options);this._delegate.messages=this.messages;this._delegate.io=this.io;this._open();this.EVENTS.forEach((function(e){this._delegate.on(e,(function(s){t.emit(e,s)}))}),this);this.protocol=this._delegate.protocol;this.version=this._delegate.version;this.parse(this._http.body);this.emit("connect",new he.ConnectEvent)}},_open:function(){this.__queue.forEach((function(e){this._delegate[e[0]].apply(this._delegate,e[1])}),this);this.__queue=[]}};["addExtension","setHeader","start","frame","text","binary","ping","close"].forEach((function(e){ce[e]=function(){if(this._delegate)return this._delegate[e].apply(this._delegate,arguments);this.__queue.push([e,arguments]);return true}}));for(var de in ce)Server.prototype[de]=ce[de];Server.isSecureRequest=function(e){if(e.connection&&void 0!==e.connection.authorized)return true;if(e.socket&&e.socket.secure)return true;var t=e.headers;return!!t&&("on"===t["https"]||("on"===t["x-forwarded-ssl"]||("https"===t["x-forwarded-scheme"]||"https"===t["x-forwarded-proto"])))};Server.determineUrl=function(e){var t=this.isSecureRequest(e)?"wss:":"ws:";return t+"//"+e.headers.host+e.url};Server.http=function(e,t){t=t||{};void 0===t.requireMasking&&(t.requireMasking=true);var s=e.headers,r=s["sec-websocket-version"],i=s["sec-websocket-key"],a=s["sec-websocket-key1"],h=s["sec-websocket-key2"],n=this.determineUrl(e);return r||i?new ue(e,n,t):a||h?new oe(e,n,t):new ne(e,n,t)};re=Server;var fe=re;var _e={};var pe=r,le=x,ge=fe;var Se={client:function(e,t){t=t||{};void 0===t.masking&&(t.masking=true);return new le(e,t)},server:function(e){e=e||{};void 0===e.requireMasking&&(e.requireMasking=true);return new ge(e)},http:function(){return ge.http.apply(ge,arguments)},isSecureRequest:function(e){return ge.isSecureRequest(e)},isWebSocket:function(e){return pe.isWebSocket(e)},validateOptions:function(e,t){pe.validateOptions(e,t)}};_e=Se;var ve=_e;export default ve;

