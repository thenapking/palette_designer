// http-proxy@1.18.1 downloaded from https://ga.jspm.io/npm:http-proxy@1.18.1/index.js

import e from"util";import r from"url";import t from"eventemitter3";import o from"http";import s from"https";import"requires-port";import n from"./lib/http-proxy/common.js";import i from"./lib/http-proxy/passes/web-outgoing.js";import a from"follow-redirects";import f from"buffer";var c={};var p=o,u=s,h=i,d=n,l=a;h=Object.keys(h).map((function(e){return h[e]}));var w={http:p,https:u};c={deleteLength:function deleteLength(e,r,t){if(("DELETE"===e.method||"OPTIONS"===e.method)&&!e.headers["content-length"]){e.headers["content-length"]="0";delete e.headers["transfer-encoding"]}},timeout:function timeout(e,r,t){t.timeout&&e.socket.setTimeout(t.timeout)},XHeaders:function XHeaders(e,r,t){if(t.xfwd){var o=e.isSpdy||d.hasEncryptedConnection(e);var s={for:e.connection.remoteAddress||e.socket.remoteAddress,port:d.getPort(e),proto:o?"https":"http"};["for","port","proto"].forEach((function(r){e.headers["x-forwarded-"+r]=(e.headers["x-forwarded-"+r]||"")+(e.headers["x-forwarded-"+r]?",":"")+s[r]}));e.headers["x-forwarded-host"]=e.headers["x-forwarded-host"]||e.headers["host"]||""}},stream:function stream(e,r,t,o,s,n){s.emit("start",e,r,t.target||t.forward);var i=t.followRedirects?l:w;var a=i.http;var f=i.https;if(t.forward){var c=("https:"===t.forward.protocol?f:a).request(d.setupOutgoing(t.ssl||{},t,e,"forward"));var p=createErrorHandler(c,t.forward);e.on("error",p);c.on("error",p);(t.buffer||e).pipe(c);if(!t.target)return r.end()}var u=("https:"===t.target.protocol?f:a).request(d.setupOutgoing(t.ssl||{},t,e));u.on("socket",(function(o){s&&!u.getHeader("expect")&&s.emit("proxyReq",u,e,r,t)}));t.proxyTimeout&&u.setTimeout(t.proxyTimeout,(function(){u.abort()}));e.on("aborted",(function(){u.abort()}));var v=createErrorHandler(u,t.target);e.on("error",v);u.on("error",v);function createErrorHandler(t,o){return function proxyError(i){if(e.socket.destroyed&&"ECONNRESET"===i.code){s.emit("econnreset",i,e,r,o);return t.abort()}n?n(i,e,r,o):s.emit("error",i,e,r,o)}}(t.buffer||e).pipe(u);u.on("response",(function(o){s&&s.emit("proxyRes",o,e,r);if(!r.headersSent&&!t.selfHandleResponse)for(var n=0;n<h.length;n++)if(h[n](e,r,o,t))break;if(r.finished)s&&s.emit("end",e,r,o);else{o.on("end",(function(){s&&s.emit("end",e,r,o)}));t.selfHandleResponse||o.pipe(r)}}))}};var v=c;var m={};var y=o,g=s,x=n;m={checkMethodAndHeader:function checkMethodAndHeader(e,r){if("GET"!==e.method||!e.headers.upgrade){r.destroy();return true}if("websocket"!==e.headers.upgrade.toLowerCase()){r.destroy();return true}},XHeaders:function XHeaders(e,r,t){if(t.xfwd){var o={for:e.connection.remoteAddress||e.socket.remoteAddress,port:x.getPort(e),proto:x.hasEncryptedConnection(e)?"wss":"ws"};["for","port","proto"].forEach((function(r){e.headers["x-forwarded-"+r]=(e.headers["x-forwarded-"+r]||"")+(e.headers["x-forwarded-"+r]?",":"")+o[r]}))}},stream:function stream(e,r,t,o,s,n){var createHttpHeader=function(e,r){return Object.keys(r).reduce((function(e,t){var o=r[t];if(!Array.isArray(o)){e.push(t+": "+o);return e}for(var s=0;s<o.length;s++)e.push(t+": "+o[s]);return e}),[e]).join("\r\n")+"\r\n\r\n"};x.setupSocket(r);o&&o.length&&r.unshift(o);var i=(x.isSSL.test(t.target.protocol)?g:y).request(x.setupOutgoing(t.ssl||{},t,e));s&&s.emit("proxyReqWs",i,e,r,t,o);i.on("error",onOutgoingError);i.on("response",(function(e){if(!e.upgrade){r.write(createHttpHeader("HTTP/"+e.httpVersion+" "+e.statusCode+" "+e.statusMessage,e.headers));e.pipe(r)}}));i.on("upgrade",(function(e,t,o){t.on("error",onOutgoingError);t.on("end",(function(){s.emit("close",e,t,o)}));r.on("error",(function(){t.end()}));x.setupSocket(t);o&&o.length&&t.unshift(o);r.write(createHttpHeader("HTTP/1.1 101 Switching Protocols",e.headers));t.pipe(r).pipe(t);s.emit("open",t);s.emit("proxySocket",t)}));return i.end();function onOutgoingError(t){n?n(t,e,r):s.emit("error",t,e,r);r.end()}}};var b=m;var P="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var E={};var S=f.Buffer;var k=E,R=e._extend,H=r.parse,T=t,O=o,q=s,A=v,j=b;k.Server=ProxyServer;function createRightProxy(e){return function(r){return function(t,o){var s="ws"===e?(this||P).wsPasses:(this||P).webPasses,n=[].slice.call(arguments),i=n.length-1,a,f;if("function"===typeof n[i]){f=n[i];i--}var c=r;if(!(n[i]instanceof S)&&n[i]!==o){c=R({},r);R(c,n[i]);i--}n[i]instanceof S&&(a=n[i]);["target","forward"].forEach((function(e){"string"===typeof c[e]&&(c[e]=H(c[e]))}));if(!c.target&&!c.forward)return this.emit("error",new Error("Must provide a proper URL as target"));for(var p=0;p<s.length;p++)if(s[p](t,o,c,a,this||P,f))break}}}k.createRightProxy=createRightProxy;function ProxyServer(e){T.call(this||P);e=e||{};e.prependPath=false!==e.prependPath;(this||P).web=(this||P).proxyRequest=createRightProxy("web")(e);(this||P).ws=(this||P).proxyWebsocketRequest=createRightProxy("ws")(e);(this||P).options=e;(this||P).webPasses=Object.keys(A).map((function(e){return A[e]}));(this||P).wsPasses=Object.keys(j).map((function(e){return j[e]}));this.on("error",(this||P).onError,this||P)}e.inherits(ProxyServer,T);ProxyServer.prototype.onError=function(e){if(1===this.listeners("error").length)throw e};ProxyServer.prototype.listen=function(e,r){var t=this||P,closure=function(e,r){t.web(e,r)};(this||P)._server=(this||P).options.ssl?q.createServer((this||P).options.ssl,closure):O.createServer(closure);(this||P).options.ws&&(this||P)._server.on("upgrade",(function(e,r,o){t.ws(e,r,o)}));(this||P)._server.listen(e,r);return this||P};ProxyServer.prototype.close=function(e){var r=this||P;(this||P)._server&&(this||P)._server.close(done);function done(){r._server=null;e&&e.apply(null,arguments)}};ProxyServer.prototype.before=function(e,r,t){if("ws"!==e&&"web"!==e)throw new Error("type must be `web` or `ws`");var o="ws"===e?(this||P).wsPasses:(this||P).webPasses,s=false;o.forEach((function(e,t){e.name===r&&(s=t)}));if(false===s)throw new Error("No such pass");o.splice(s,0,t)};ProxyServer.prototype.after=function(e,r,t){if("ws"!==e&&"web"!==e)throw new Error("type must be `web` or `ws`");var o="ws"===e?(this||P).wsPasses:(this||P).webPasses,s=false;o.forEach((function(e,t){e.name===r&&(s=t)}));if(false===s)throw new Error("No such pass");o.splice(s++,0,t)};var _={};var L=E.Server;function createProxyServer(e){return new L(e)}L.createProxyServer=createProxyServer;L.createServer=createProxyServer;L.createProxy=createProxyServer;_=L;var C=_;export default C;

