// faye-websocket@0.11.4 downloaded from https://ga.jspm.io/npm:faye-websocket@0.11.4/lib/faye/websocket.js

import*as t from"util";import*as e from"websocket-driver";import*as r from"stream";import i from"buffer";import*as s from"net";import*as n from"tls";import*as a from"url";import*as o from"websocket-driver/lib/websocket/driver/headers";import h from"process";var f={};var Event$4=function(t,e){this.type=t;for(var r in e)this[r]=e[r]};Event$4.prototype.initEvent=function(t,e,r){this.type=t;this.bubbles=e;this.cancelable=r};Event$4.prototype.stopPropagation=function(){};Event$4.prototype.preventDefault=function(){};Event$4.CAPTURING_PHASE=1;Event$4.AT_TARGET=2;Event$4.BUBBLING_PHASE=3;f=Event$4;var d=f;var c={};var l=d;var u={onopen:null,onmessage:null,onerror:null,onclose:null,addEventListener:function(t,e,r){this.on(t,e)},removeEventListener:function(t,e,r){this.removeListener(t,e)},dispatchEvent:function(t){t.target=t.currentTarget=this;t.eventPhase=l.AT_TARGET;this["on"+t.type]&&this["on"+t.type](t);this.emit(t.type,t)}};c=u;var v=c;var _="default"in r?r.default:r;var p="default"in t?t.default:t;var m="default"in e?e.default:e;var E={};var g=i.Buffer;var y=_.Stream,S=p,T=m,C=v,N=d;var API$3=function(t){t=t||{};T.validateOptions(t,["headers","extensions","maxLength","ping","proxy","tls","ca"]);this.readable=this.writable=true;var e=t.headers;if(e)for(var r in e)this._driver.setHeader(r,e[r]);var i=t.extensions;i&&[].concat(i).forEach(this._driver.addExtension,this._driver);this._ping=t.ping;this._pingId=0;this.readyState=API$3.CONNECTING;this.bufferedAmount=0;this.protocol="";this.url=this._driver.url;this.version=this._driver.version;var s=this;this._driver.on("open",(function(t){s._open()}));this._driver.on("message",(function(t){s._receiveMessage(t.data)}));this._driver.on("close",(function(t){s._beginClose(t.reason,t.code)}));this._driver.on("error",(function(t){s._emitError(t.message)}));this.on("error",(function(){}));this._driver.messages.on("drain",(function(){s.emit("drain")}));this._ping&&(this._pingTimer=setInterval((function(){s._pingId+=1;s.ping(s._pingId.toString())}),1e3*this._ping));this._configureStream();if(!this._proxy){this._stream.pipe(this._driver.io);this._driver.io.pipe(this._stream)}};S.inherits(API$3,y);API$3.CONNECTING=0;API$3.OPEN=1;API$3.CLOSING=2;API$3.CLOSED=3;API$3.CLOSE_TIMEOUT=3e4;var O={write:function(t){return this.send(t)},end:function(t){void 0!==t&&this.send(t);this.close()},pause:function(){return this._driver.messages.pause()},resume:function(){return this._driver.messages.resume()},send:function(t){if(this.readyState>API$3.OPEN)return false;t instanceof g||(t=String(t));return this._driver.messages.write(t)},ping:function(t,e){return!(this.readyState>API$3.OPEN)&&this._driver.ping(t,e)},close:function(t,e){void 0===t&&(t=1e3);void 0===e&&(e="");if(1e3!==t&&(t<3e3||t>4999))throw new Error("Failed to execute 'close' on WebSocket: The code must be either 1000, or between 3000 and 4999. "+t+" is neither.");if(this.readyState<API$3.CLOSING){var r=this;this._closeTimer=setTimeout((function(){r._beginClose("",1006)}),API$3.CLOSE_TIMEOUT)}this.readyState!==API$3.CLOSED&&(this.readyState=API$3.CLOSING);this._driver.close(e,t)},_configureStream:function(){var t=this;this._stream.setTimeout(0);this._stream.setNoDelay(true);["close","end"].forEach((function(e){this._stream.on(e,(function(){t._finalizeClose()}))}),this);this._stream.on("error",(function(e){t._emitError("Network error: "+t.url+": "+e.message);t._finalizeClose()}))},_open:function(){if(this.readyState===API$3.CONNECTING){this.readyState=API$3.OPEN;this.protocol=this._driver.protocol||"";var t=new N("open");t.initEvent("open",false,false);this.dispatchEvent(t)}},_receiveMessage:function(t){if(this.readyState>API$3.OPEN)return false;this.readable&&this.emit("data",t);var e=new N("message",{data:t});e.initEvent("message",false,false);this.dispatchEvent(e)},_emitError:function(t){if(!(this.readyState>=API$3.CLOSING)){var e=new N("error",{message:t});e.initEvent("error",false,false);this.dispatchEvent(e)}},_beginClose:function(t,e){if(this.readyState!==API$3.CLOSED){this.readyState=API$3.CLOSING;this._closeParams=[t,e];if(this._stream){this._stream.destroy();this._stream.readable||this._finalizeClose()}}},_finalizeClose:function(){if(this.readyState!==API$3.CLOSED){this.readyState=API$3.CLOSED;this._closeTimer&&clearTimeout(this._closeTimer);this._pingTimer&&clearInterval(this._pingTimer);this._stream&&this._stream.end();this.readable&&this.emit("end");this.readable=this.writable=false;var t=this._closeParams?this._closeParams[0]:"",e=this._closeParams?this._closeParams[1]:1006;var r=new N("close",{code:e,reason:t});r.initEvent("close",false,false);this.dispatchEvent(r)}}};for(var w in O)API$3.prototype[w]=O[w];for(var b in C)API$3.prototype[b]=C[b];E=API$3;var x=E;var L="default"in t?t.default:t;var I="default"in s?s.default:s;var P="default"in n?n.default:n;var G="default"in a?a.default:a;var D="default"in e?e.default:e;var k={};var A=L,R=I,U=P,F=G,H=D,M=x;var z={"http:":80,"https:":443,"ws:":80,"wss:":443},B=["https:","wss:"];var Client=function(t,e,r){r=r||{};this.url=t;this._driver=H.client(this.url,{maxLength:r.maxLength,protocols:e});["open","error"].forEach((function(t){this._driver.on(t,(function(){d.headers=d._driver.headers;d.statusCode=d._driver.statusCode}))}),this);var i=r.proxy||{},s=F.parse(i.origin||this.url),n=s.port||z[s.protocol],a=B.indexOf(s.protocol)>=0,onConnect=function(){d._onConnect()},o=r.net||{},h=r.tls||{},f=i.origin?i.tls||{}:h,d=this;o.host=f.host=s.hostname;o.port=f.port=n;h.ca=h.ca||r.ca;f.servername=f.servername||s.hostname;this._stream=a?U.connect(f,onConnect):R.connect(o,onConnect);i.origin&&this._configureProxy(i,h);M.call(this,r)};A.inherits(Client,M);Client.prototype._onConnect=function(){var t=this._proxy||this._driver;t.start()};Client.prototype._configureProxy=function(t,e){var r,i=F.parse(this.url),s=B.indexOf(i.protocol)>=0,n=this;this._proxy=this._driver.proxy(t.origin);if(t.headers)for(r in t.headers)this._proxy.setHeader(r,t.headers[r]);this._proxy.pipe(this._stream,{end:false});this._stream.pipe(this._proxy);this._proxy.on("connect",(function(){if(s){var t={socket:n._stream,servername:i.hostname};for(r in e)t[r]=e[r];n._stream=U.connect(t);n._configureStream()}n._driver.io.pipe(n._stream);n._stream.pipe(n._driver.io);n._driver.start()}));this._proxy.on("error",(function(t){n._driver.emit("error",t)}))};k=Client;var W=k;var Y="default"in r?r.default:r;var q="default"in t?t.default:t;var K="default"in e?e.default:e;var $="default"in o?o.default:o;var j={};var J=h;var Q=Y.Stream,V=q,X=K,Z=$,tt=x,et=v,rt=d;var EventSource=function(t,e,r){this.writable=true;r=r||{};this._stream=e.socket;this._ping=r.ping||this.DEFAULT_PING;this._retry=r.retry||this.DEFAULT_RETRY;var i=X.isSecureRequest(t)?"https:":"http:";this.url=i+"//"+t.headers.host+t.url;this.lastEventId=t.headers["last-event-id"]||"";this.readyState=tt.CONNECTING;var s=new Z,n=this;if(r.headers)for(var a in r.headers)s.set(a,r.headers[a]);if(this._stream&&this._stream.writable){J.nextTick((function(){n._open()}));this._stream.setTimeout(0);this._stream.setNoDelay(true);var o="HTTP/1.1 200 OK\r\nContent-Type: text/event-stream\r\nCache-Control: no-cache, no-store\r\nConnection: close\r\n"+s.toString()+"\r\nretry: "+Math.floor(1e3*this._retry)+"\r\n\r\n";this._write(o);this._stream.on("drain",(function(){n.emit("drain")}));this._ping&&(this._pingTimer=setInterval((function(){n.ping()}),1e3*this._ping));["error","end"].forEach((function(t){n._stream.on(t,(function(){n.close()}))}))}};V.inherits(EventSource,Q);EventSource.isEventSource=function(t){if("GET"!==t.method)return false;var e=(t.headers.accept||"").split(/\s*,\s*/);return e.indexOf("text/event-stream")>=0};var it={DEFAULT_PING:10,DEFAULT_RETRY:5,_write:function(t){if(!this.writable)return false;try{return this._stream.write(t,"utf8")}catch(t){return false}},_open:function(){if(this.readyState===tt.CONNECTING){this.readyState=tt.OPEN;var t=new rt("open");t.initEvent("open",false,false);this.dispatchEvent(t)}},write:function(t){return this.send(t)},end:function(t){void 0!==t&&this.write(t);this.close()},send:function(t,e){if(this.readyState>tt.OPEN)return false;t=String(t).replace(/(\r\n|\r|\n)/g,"$1data: ");e=e||{};var r="";e.event&&(r+="event: "+e.event+"\r\n");e.id&&(r+="id: "+e.id+"\r\n");r+="data: "+t+"\r\n\r\n";return this._write(r)},ping:function(){return this._write(":\r\n\r\n")},close:function(){if(this.readyState>tt.OPEN)return false;this.readyState=tt.CLOSED;this.writable=false;this._pingTimer&&clearInterval(this._pingTimer);this._stream&&this._stream.end();var t=new rt("close");t.initEvent("close",false,false);this.dispatchEvent(t);return true}};for(var st in it)EventSource.prototype[st]=it[st];for(var nt in et)EventSource.prototype[nt]=et[nt];j=EventSource;var at=j;var ot="default"in t?t.default:t;var ht="default"in e?e.default:e;var ft={};var dt=h;var ct=ot,lt=ht,ut=x;var WebSocket=function(t,e,r,i,s){s=s||{};this._stream=e;this._driver=lt.http(t,{maxLength:s.maxLength,protocols:i});var n=this;if(this._stream&&this._stream.writable){if(!this._stream.readable)return this._stream.end();var catchup=function(){n._stream.removeListener("data",catchup)};this._stream.on("data",catchup);ut.call(this,s);dt.nextTick((function(){n._driver.start();n._driver.io.write(r)}))}};ct.inherits(WebSocket,ut);WebSocket.isWebSocket=function(t){return lt.isWebSocket(t)};WebSocket.validateOptions=function(t,e){lt.validateOptions(t,e)};WebSocket.WebSocket=WebSocket;WebSocket.Client=W;WebSocket.EventSource=at;ft=WebSocket;var vt=ft;export default vt;

